{% extends "base.html" %}
 {% load cache facets i18n param category product paginator mptt_tags seo booking %}

{% block title %}
{% if breadcrumbs.categorie.object.description %}
{{ breadcrumbs.categorie.object.description.title }}
{% else %}
{% trans "Location" %}{% if not form.cleaned_data.q %}{% for crumb in breadcrumbs|facets %} {{ crumb.pretty_value|capfirst }}{% endfor %}{% endif %}{% if form.cleaned_data.q %} {{ form.cleaned_data.q }}{% endif %}{% if form.cleaned_data.l %} {{ form.cleaned_data.l|capfirst }}{% endif %}
{% endif %}
{% endblock %}

{% block description %}
{% if breadcrumbs.categorie.object.description %}
{{ breadcrumbs.categorie.object.description.description }}
{% else %}
{% trans "Location " %}
{% for crumb in breadcrumbs|facets %}
&rsaquo; {{ crumb.pretty_value|capfirst }}
{% endfor %}
{% if form.cleaned_data.l %}
&rsaquo; {{ form.cleaned_data.l|capfirst }}
{% endif %}
{% if form.cleaned_data.q %}
&rsaquo; &quot;{{ form.cleaned_data.q }}&quot;
{% endif %}
{% endif %}
{% endblock %}

{% block  head %}
    {{ block.super }}
    {% if breadcrumbs.categorie %}
        <link rel="canonical" href="{% if request.is_secure %}https{%else%}http{%endif%}://{{ request.get_host }}{{ breadcrumbs.categorie.url }}{% if page > 1 %}page/{{page}}/{% endif %}{{canonical_parameters}}"/>
    {% else %}
        <link rel="canonical" href="{% if request.is_secure %}https{%else%}http{%endif%}://{{ request.get_host }}/location/{% if page > 1%}page/{{page}}/{% endif %}{{canonical_parameters}}"/>
    {% endif %}

    {% if page_obj.has_next %}
        {% if breadcrumbs.categorie %}
            <link rel="next" href="{% if request.is_secure %}https{%else%}http{%endif%}://{{ request.get_host }}{{ breadcrumbs.categorie.url }}page/{{page_obj.next_page_number}}/{{canonical_parameters}}"/>
        {% else %}
            <link rel="next" href="{% if request.is_secure %}https{%else%}http{%endif%}://{{ request.get_host }}/location/page/{{page_obj.next_page_number}}/{{canonical_parameters}}"/>
        {% endif %}
    {% endif %}

    {% if page_obj.has_previous %}
        {% if page == 2%}
            {% if breadcrumbs.categorie %}
                <link rel="prev" href="{% if request.is_secure %}https{%else%}http{%endif%}://{{ request.get_host }}{{ breadcrumbs.categorie.url }}{{canonical_parameters}}"/>
            {% else %}
                <link rel="prev" href="{% if request.is_secure %}https{%else%}http{%endif%}://{{ request.get_host }}/location/{{canonical_parameters}}"/>
            {% endif %}
        {% else %}
            {% if breadcrumbs.categorie %}
                <link rel="prev" href="{% if request.is_secure %}https{%else%}http{%endif%}://{{ request.get_host }}{{ breadcrumbs.categorie.url }}page/{{page_obj.previous_page_number}}/{{canonical_parameters}}"/>
            {% else %}
                <link rel="prev" href="{% if request.is_secure %}https{%else%}http{%endif%}://{{ request.get_host }}/location/page/{{page_obj.previous_page_number}}/{{canonical_parameters}}"/>
            {% endif %}
        {% endif %}
    {% endif %}

{% endblock %}

{% block content %}

<div id="result-page" class="container-main">
    <ul class="breadcrumb">
        <li><a href="{% url home %}">{% trans "Accueil" %}</a></li>
        {% for crumb in breadcrumbs|facets %}
			{% if form.cleaned_data.l or form.cleaned_data.q %}
			    {% for category in crumb.object.get_ancestors %}
    			 <li><a href="{{ category.get_absolute_url }}">{{ category.name|capfirst }}</a></li>
    			{% endfor %}
				<li><a href="{{ crumb.url }}">{{ crumb.pretty_value|capfirst }}</a></li>
			{% else %}
			    {% for category in crumb.object.get_ancestors %}
    			 <li><a href="{{ category.get_absolute_url }}">{{ category.name|capfirst }}</a></li>
    			{% endfor %}
				<li class="lastb">{{ crumb.pretty_value|capfirst }}</a></li>
			{% endif %}
		{% endfor %}
		{% if form.cleaned_data.q %}
			{% if form.cleaned_data.l %}
				<li><a href="{% facet_url breadcrumbs -"l" -"r" %}">{% trans "location" %} {{ form.cleaned_data.q }}</a></li>
			{% else %}
				<li class="lastb">{% trans "location" %} {{ form.cleaned_data.q }}</li>
			{% endif %}
		{% endif %}
		{% if form.cleaned_data.l %}
			<li class="lastb">{{ form.cleaned_data.l|capfirst }}</li>
		{% endif %}
    </ul>{# breadcrumb #}
    <div class="content-main">
    {% if product_list %}
        {% if form.cleaned_data.q %}
        {% blocktrans with form.cleaned_data.q as keywords count paginator.count as count %}
            <h1>Résultat pour <strong>"{{ keywords }}"</strong></h1>
            {% plural %}
            <h1>Résultats pour <strong>"{{ keywords }}"</strong></h1>
        {% endblocktrans%}
        {% endif %}
        <ul class="product-filter">
            <li class="filter-title">Trier par</li>
            <li {% if form.sort.data == "-created_at" %} class="filter-selected" {% endif %}>
                {% if form.sort.data == "-created_at" %}
                    {% trans "Les plus récents" %}
                {% else %}
                    <a href="{% facet_url breadcrumbs "sort" "-created_at" %}">{% trans "Les plus récents" %}</a>
                {% endif %}
            </li>
            {% if form.cleaned_data.l %}
            <li {% if form.sort.data == "geo_distance" %} class="filter-selected" {% endif %}>
                {% if form.sort.data == "geo_distance" %}
                {% trans "Les plus proches" %}
                {% else %}
                <a href="{% facet_url breadcrumbs "sort" "geo_distance" %}">{% trans "Les plus proches" %}</a>
                {% endif %}
            </li>
            {% endif %}
            <li {% if form.sort.data == "price" %} class="filter-selected" {% endif %}>
                {% if form.sort.data == "price" %}
                    {% trans "Les prix les plus bas" %}
                {% else %}
                    <a href="{% facet_url breadcrumbs "sort" "price" %}">{% trans "Les prix les plus bas" %}</a>
                {% endif %}
            </li>
            <li {% if form.sort.data == "-price" %} class="filter-selected" {% endif %}>
                {% if form.sort.data == "-price" %}
                    {% trans "Les prix les plus haut" %}
                {% else %}
                    <a href="{% facet_url breadcrumbs "sort" "-price" %}">{% trans "Les prix les plus haut" %}</a>
                {% endif %}
            </li>
        </ul>{# product_filter #}
        {% with 50 as truncation %}
            {% include 'products/partials/result_list.html' %}
        {% endwith %}
        {% pagination %}
        {% if is_paginated %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="{% facet_url breadcrumbs "page" page_obj.previous_page_number %}" class="prev">&#171; {% trans "Page précédente" %}</a>
            {% endif %}
            {% for page in page_range %}
            <a href="{% facet_url breadcrumbs "page" page %}" {% if page_obj.number == page %}class="page-selected"{% endif %}>{{ page }}</a>
            {% endfor %}
            {% if page_obj.has_next %}
                <a href="{% facet_url breadcrumbs "page" page_obj.next_page_number %}" class="next">{% trans "Page suivante" %} &#187;</a>
            {% endif %}
        </div><!-- pagination -->
        {% endif %}
    {% else %}
    <h1>{% trans "Pas de résultat pour cette recherche" %}</h1>
    {% endif %}
    </div>{# content-main #}
    <div class="content-aside">
        <div class="searh-block">
            <form action="{% url product_list %}" method="get" id="form_search_results">
                {{form.q}}
                <input type="submit" value="Rechercher" class="btn-search"/>
            </form>
        </div><!-- search-block -->
        <div id="where" class="info-block">
            <h2>Lieu</h2>
            <p class="town-input"><input id="id_l" type="text" name="l" value="{% firstof request.session.location.city request.session.location.region request.session.location.country request.session.location.fallback "" %}"/></p>
            <div id="map-canvas" class="map"></div>
            <p class="radius-input">Dans un rayon de <input type="text" name="r" value="{{request.session.location.radius}}"/> Km</p>
        </div><!-- where -->
        {% if product_list %}
        <div id ="facet-categories" class="info-block">
            <h2>{% trans "Catégories" %}</h2>
            {% if breadcrumbs.categorie %}
            <p>
                <a href="{% facet_url breadcrumbs -breadcrumbs.categorie.label %}">
                    {% trans "Voir tous les résultats" %}
                </a>
            </p>
            {% endif %}
            {% if facets.fields.categories %}
            <ul>
                {% for value, count in facets.fields.categories %}
                {% if count > 0 %}
                {% with value|category as category %}
                 {% if category != 'None' %}
                    {% if breadcrumbs.categorie %}
                    {% if breadcrumbs.categorie.value != category.slug %}
                    <li>
    					<a href="{% facet_url breadcrumbs -breadcrumbs.categorie.label category.get_ancertors_slug category.slug %}">
    					    {{ category.name }}
    					</a> 
    				</li>
    				{% endif %}
					{% else %}
					<li>
						<a href="{% facet_url breadcrumbs category.get_ancertors_slug category.slug %}">{{ category.name }}</a> 
					</li>
					{% endif %}
				{% endif %}
                {% endwith%}
                {% endif %}
                {% endfor %}
            </ul>
            {% endif %}
        </div>{# facet-categories #}
        {% endif %}
    </div>{# content-aside #}
</div>{# container-main #}
</div>

{% endblock %}

{% block tail %}
{{block.super}}

  <script src="//maps.googleapis.com/maps/api/js?sensor=false&amp;libraries=places" type="text/javascript"></script>
  <script type="text/javascript">
 
    function SuccessBuilder(priority, geocodeSuccess) {
        return function(position) {
            geocoder = new google.maps.Geocoder();
            latlon = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            geocoder.geocode(
                {'latLng':latlon}, 
                function(result) {
                    report_location_back(priority, result[0], latlon, function(response) {
                        if (response == "OK") {
                            geocodeSuccess();
                        }
                    })
                }
            );
        };
    }
    navigator.geolocation.getCurrentPosition(SuccessBuilder(2, function() {$("#form_search_results").submit();}));


    autocomplete = new google.maps.places.Autocomplete(document.getElementById("id_l"), {types: ['geocode']});
    google.maps.event.addListener(autocomplete, 'place_changed', function() {
      place = autocomplete.getPlace();
      report_location_back(1, place, place.geometry.location, function(response){
        if (response == "OK") {
          $("#form_search_results").submit();
        }
      });
    });


    function initialize() {
        var myLatlng = new google.maps.LatLng('{{request.session.location.coordinates.0}}'.replace(',','.'), '{{request.session.location.coordinates.1}}'.replace(',','.'));
        var myOptions = {
            zoom: 13,
            disableDefaultUI: true,
            center: myLatlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        }
        var map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

        var marker = new google.maps.Marker({
            position: myLatlng, 
            map: map,
            title:"Hello World!"
        });
        // var circle = new google.maps.Circle({
        //   map: map,
        //   radius: Number('{{request.session.location.radius}}'.replace(',', '.'))*1000,    // 10 miles in metres
        //   fillColor: '#AA0000'
        // });
        // circle.bindTo('center', marker, 'position');
    }

    initialize();    
    
  </script>
{% endblock %}
