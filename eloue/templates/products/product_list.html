{% extends "base.html" %}
 {% load cache facets i18n param category product paginator mptt_tags %}

{% block title %}{% spaceless %}
 {% if breadcrumbs %}
	{% if form.cleaned_data.q %}
	 {% trans "Location" %}
	 {% for crumb in breadcrumbs.values %}
	  {% if crumb.facet %}
	   &rsaquo; {{ crumb.pretty_value|capfirst }}
	  {% endif %}
	 {% endfor %} &rsaquo; {{ form.cleaned_data.q }} - {{ block.super }}
	{% else %}
	 {% trans "Location" %}
	 {% for crumb in breadcrumbs.values %}
	  {% if crumb.facet %}
	   &rsaquo; {{ crumb.pretty_value|capfirst }}
	  {% endif %}
	 {% endfor %} - {{ block.super }}
  {% endif %}
 {% else %}
	{% if form.cleaned_data.q %}
 	 {{ form.cleaned_data.q }} - {{ block.super }}
	{% else %}
	 {% trans "Location" %} - {{ block.super }}
	{% endif %}
 {% endif %}
{% endspaceless %}{% endblock %}

{% block description %}{% if breadcrumbs %} {% trans "Location" %} {% for crumb in breadcrumbs.values %}{% if crumb.facet %} &rsaquo; {{ crumb.pretty_value|capfirst }}{% endif %}{% endfor %} {% else %} {{ block.super }}{% endif %}{% endblock %}

{% block  head %}
 {{ block.super }}
 <link rel="canonical" href="{% canonical_url urlbits %}" />
{% endblock %}

{% block content %}
<div id="top-content" class="search clearfix">
	<form class="form" action="{% url product_list %}">
	<div class="search-what x5">
		<label for="id_q">{% trans "Que voulez-vous louer ?" %}</label><br />
		{{ form.q }}<br />
		<span>{% trans "Exemple :" %} </span> <a href="location/?q=voiture">{% trans "Voiture" %}</a>, <a href="#">{% trans "Chèvre" %}</a>, <a href="#">{% trans "Ski" %}</a>, <a href="#">{% trans "Robe" %}</a>
	</div>
	<div class="search-where x5">
		<label>{% trans "Où ?" %}</label><br />
		{{ form.where }}<br />
	</div>
	<div class="search-find x2">
		<input type="submit" value="{% trans "Rechercher" %}" class="btn big-orange"/>
	</div>
	</form>
</div>{# top-content #}
<div id="content" class="result clearfix">
	<div class="content-header x12">
		{% if form.cleaned_data.q %}
		<h1>{{ paginator.count }} résultat{{ paginator.count|pluralize }} pour <strong>{{ form.cleaned_data.q }}</strong></h1>
		{% endif %}
	</div>
	{% if suggestions %}
	<div class="suggestion x12">
		Vous vouliez peut-être dire ? <a href="{% facet_url breadcrumbs "q" suggestions %}">{{ suggestions }}</a>
	</div>
	{% endif%}
	{% if product_list %}
	<div class="x8">
			<ul class="sort x8 first">
				<li class="label-sort">
					{% trans "Trier par :" %}
				</li>
				<li>
					<a href="{% facet_url breadcrumbs "sort" "created_at" %}">{% trans "Les plus récents" %}</a>
				</li>
				{% if form.cleaned_data.where %}
				<li><a href="{% facet_url breadcrumbs "sort" "geo_distance" %}">{% trans "Les plus proches" %}</a></li>
				{% endif %}
				<li>
					<a href="{% facet_url breadcrumbs "sort" "price" %}">{% trans "Les prix les plus bas" %}</a>
				</li>
		    <li class="last-sort">
					<a href="{% facet_url breadcrumbs "sort" "-price" %}">{% trans "Les prix les plus haut" %}</a>
				</li>
			</ul>
			<ul class="product-list x8 first">
				{% for product in product_list %}
					{% cache 900 product:row product.pk form.cleaned_data.q form.cleaned_data.where %}
						{% with product.object as object %}
						<li class="x8 first">
							<a class="pl-img" href="{{ object.get_absolute_url }}">
								{% with object.pictures.all|first as picture %}
	     	          {% if picture.thumbnail %}
	 	               <img src="{{ picture.thumbnail.url }}" alt="product.summary" />
		              {% endif %}
		             {% endwith %}
							</a>
							<div class="pl-header">
								<h2><a href="{{ object.get_absolute_url }}">{{ product.summary|capfirst|truncate:50 }}</a></h2>
							</div>
							<div class="pl-content">
								{% with product.highlighted.text|first|truncate:180|safe as highlight %}
									{% if highlight %}
									<div class="pl-desc">{{ highlight }}</div>
									{% else %}
									<div class="pl-desc">{{ product.description|truncate:180 }}</div>
									{% endif %}
								{% endwith %}
								<div class="pl-distance">
									{% if product.geo_distance %}
										{{ product.geo_distance|floatformat }} km{{ product.geo_distance|pluralize }}
									{% endif %}
								</div>
								<div class="pl-price">
									<span class="price">{{ product.price }}&euro;</span><br />
									<span class="unit">par jour</span>
								</div>
								<div class="pl-btn">
									<a href="{{ object.get_absolute_url }}" class="btn small-blue">{% trans "Réserver" %} &rarr;</a>
								</div>
							</div>
							<div class="pl-footer">
								Par <a href="{{ object.owner.get_absolute_url }}" class="owner">{{ object.owner.username }}</a> | {{ object.address.city|capfirst }}, {{ object.address.zipcode }}
							</div>
						</li>
						{% endwith %}
					{% endcache %}
				{% endfor %}
			</ul>{# list #}
			{% pagination %}
	</div>
	{% if form.cleaned_data.where %}
	<div class="facet-dist portlet x4">
		<div class="portlet-header">
			<h3>{% trans "Distance" %}</h3>
		</div>
		<div class="portlet-top">
			<form action="{% facet_url breadcrumbs %}" class="form">
				<p>
					<input type="hidden" value="{{ form.cleaned_data.q }}" name="q"/>
			    <input type="hidden" value="{{ form.cleaned_data.where }}" name="where"/>
					{{ form.sort }}
					<label class="labs">{% trans "Restreindre les résultats à un rayon de" %}</label><br />
					{{ form.radius }}
					<span class="unit">Km</span>
					<input type="submit" value="Mettre à jour" class="btn medium-blue"/>
				</p>
			</form>
		</div>
	</div>
	{% endif %}
	<div class="facet-cat portlet x4">
		<div class="portlet-header">
			<h3>Catégories</h3>
		</div>
		<div class="portlet-top">
			<a href="{% url product_list %}">Voir tous les résultats</a>
		</div>
		<div class="portlet-bottom">
			{% for field in form %}
				{% if not field.data %}
					{% if field.name == 'categories' %}
					<ul class="root">
						{% for value, count in facets.fields|hash:field.name  %}
							{% with value|category as category %}
								{% if category.is_root_node %}
								<li>
									<a href="{% facet_url breadcrumbs field.field.pretty_name category.slug %}">{{ category.name }}</a> 
								</li>
								{% endif%}
							{% endwith %}
						{% endfor %}
					</ul>
					{% endif%}
				{% endif %}
			{% endfor %}
		</div>
	</div>
	{% endif %}{# if product_list #}
</div>{# content #}
{% endblock %}