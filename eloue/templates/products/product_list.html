{% extends "base.html" %}
 {% load cache facets i18n param category product paginator mptt_tags %}

{% block title %}{% spaceless %}
 {% if breadcrumbs %}
  {% if form.cleaned_data.q %}
   {% trans "Location" %}
   {% for crumb in breadcrumbs.values %}
    {% if crumb.facet %}
     &rsaquo; {{ crumb.pretty_value|capfirst }}
    {% endif %}
   {% endfor %} &rsaquo; {{ form.cleaned_data.q }}
  {% else %}
   {% trans "Location" %}
   {% for crumb in breadcrumbs.values %}
    {% if crumb.facet %}
	 &rsaquo; {{ crumb.pretty_value|capfirst }}
	{% endif %}
   {% endfor %}
  {% endif %}
 {% else %}
  {% if form.cleaned_data.q %}
   {{ form.cleaned_data.q }}
  {% else %}
   {% trans "Location" %}
  {% endif %}
 {% endif %}
{% endspaceless %}{% endblock %}

{% block description %}{% if breadcrumbs %} {% trans "Location" %} {% for crumb in breadcrumbs.values %}{% if crumb.facet %} &rsaquo; {{ crumb.pretty_value|capfirst }}{% endif %}{% endfor %} {% else %} {{ block.super }}{% endif %}{% endblock %}

{% block  head %}
 {{ block.super }}
 <link rel="canonical" href="{% canonical_url urlbits %}" />
{% endblock %}

{% block content %}
<div id="top-content" class="search clearfix">
	<form class="form" action="{% url product_list %}">
	<div class="search-what x5">
		<p>
			<label for="id_q">{% trans "Que voulez-vous louer ?" %}</label><br />
			{{ form.q }}<br />
			<span>{% trans "Exemple :" %} </span> <a href="{% url product_list %}?q=voiture">{% trans "Voiture" %}</a>, <a href="{% url product_list %}?q=chèvre">{% trans "Chèvre" %}</a>, <a href="{% url product_list %}?q=ski">{% trans "Ski" %}</a>, <a href="{% url product_list %}?q=robe">{% trans "Robe" %}</a>
		</p>
	</div>
	<div class="search-where x5">
		<p>
			<label>{% trans "Où ?" %}</label><br />
			{{ form.l }}<br />
		</p>
	</div>
	<div class="search-find x2">
		<p>
			<input type="submit" value="{% trans "Rechercher" %}" class="btn big-orange"/>
		</p>
	</div>
	</form>
</div>{# top-content #}
<div id="content" class="result clearfix">
	<div class="content-header x12">
		{% if form.cleaned_data.q %}
		 <h1>Résultat{{ paginator.count|pluralize }} pour <strong>{{ form.cleaned_data.q }}</strong></h1>
		{% endif %}
	</div>
	{% if suggestions %}
	<div class="suggestion x12">
	 {% trans "Vous vouliez peut-être dire ?" %} <a href="{% facet_url breadcrumbs "q" suggestions %}">{{ suggestions }}</a>
	</div>
	{% endif%}
	{% if product_list %}
	<div class="x8">
			<ul class="sort x8 first">
				<li class="label-sort">
					{% trans "Trier par :" %}
				</li>
				<li {% if form.sort.data == "created_at" %} class="label-selected" {% endif %}>
					<a href="{% facet_url breadcrumbs "sort" "created_at" %}">{% trans "Les plus récents" %}</a>
				</li>
				{% if form.cleaned_data.l %}
				<li {% if form.sort.data == "geo_distance" %} class="label-selected" {% endif %}>
					<a href="{% facet_url breadcrumbs "sort" "geo_distance" %}">{% trans "Les plus proches" %}</a>
				</li>
				{% endif %}
				<li {% if form.sort.data == "price" %} class="label-selected" {% endif %}>
					<a href="{% facet_url breadcrumbs "sort" "price" %}">{% trans "Les prix les plus bas" %}</a>
				</li>
		    <li class="last-sort {% if form.sort.data == "-price" %} label-selected {% endif %}">
					<a href="{% facet_url breadcrumbs "sort" "-price" %}">{% trans "Les prix les plus haut" %}</a>
				</li>
				{% if form.sort.data %}
				<li class="cancel-sort">
					<a href="{% facet_url breadcrumbs -"sort" %}">X</a>
				</li>
				{% endif %}
			</ul>
			<ul class="product-list x8 first">
				{% for product in product_list %}
				  <li class="x8 first">
				   <a class="pl-img" href="{{ product.url|safe }}" {% if product|nofollow %}rel="nofollow"{% endif %}>
                    {% if product.thumbnail %}
	 	             <img width="90" height="90" src="{{ product.thumbnail }}" alt="{{ product.summary }}" />
		            {% endif %}
				   </a>
				   <div class="pl-header">
				    <h2><a href="{{ product.url|safe }}" {% if product|nofollow %}rel="nofollow"{% endif %}>{{ product.summary|capitalize|truncate:50 }}</a></h2>
				   </div>
				   <div class="pl-content">
					{% with product.highlighted.text|first|truncate:91|safe as highlight %}
				 	 {% if highlight %}
					  <div class="pl-desc">{{ highlight }}</div>
					 {% else %}
					  <div class="pl-desc">{{ product.description|truncate:91 }}</div>
					 {% endif %}
					{% endwith %}
					<div class="pl-distance">
					 {% if product.geo_distance %}
					  {{ product.geo_distance|floatformat }} km{{ product.geo_distance|pluralize }}
					 {% endif %}
					</div>
					<div class="pl-price">
					 <span class="price">{{ product.price }}&euro;</span><br />
					 <span class="unit">par jour</span>
					</div>
					<div class="pl-btn">
					 <a href="{{ product.url|safe }}" {% if product|nofollow %}rel="nofollow"{% endif %} class="btn small-blue">{% trans "Réserver" %} &rarr;</a>
					</div>
				   </div>
				   <div class="pl-footer">
				 	Par <a href="{{ product.owner_url }}" {% if product|nofollow %}rel="nofollow"{% endif %} class="owner">{{ product.owner }}</a> | {{ product.city|capfirst }}{% if product.zipcode %}, {{ product.zipcode }}{% endif %}
				   </div>
				  </li>
		  	  {% endfor %}
			</ul>{# list #}
			{% pagination %}
            {% if is_paginated %}
             <div class="pages x8 first">
              <ul class="pages-list">
	           {% if page_obj.has_previous %}
		        <li class="previous"><a href="{% facet_url breadcrumbs "page" page_obj.previous_page_number %}">&#171; {% trans "Page précédente" %}</a></li>
	           {% endif %}
	           {% for page in page_range %}
		        <li class="page-{{ page }} {% if page_obj.number == page %}select{% endif %}"><a href="{% facet_url breadcrumbs "page" page %}">{{ page }}</a></li>
		       {% endfor %}
	           {% if page_obj.has_next %}
		        <li class="next"><a href="{% facet_url breadcrumbs "page" page_obj.next_page_number %}">{% trans "Page suivante" %} &#187;</a></li>
	           {% endif %}
	          </ul> 
            </div>{# pager #}
           {% endif %}
  	</div>
	{% if form.cleaned_data.l %}
	<div class="facet-dist portlet x4">
		<div class="portlet-header">
			<h3>{% trans "Distance" %}</h3>
		</div>
		<div class="portlet-top">
			<form action="{% facet_url breadcrumbs %}" class="form">
				<p>
					<input type="hidden" value="{{ form.cleaned_data.q }}" name="q"/>
			    <input type="hidden" value="{{ form.cleaned_data.l }}" name="l"/>
					{{ form.sort }}
					<label class="labs">{% trans "Restreindre les résultats à un rayon de" %}</label><br />
					{{ form.r }}
					<span class="unit">Km</span>
					<input type="submit" value="Mettre à jour" class="btn medium-blue"/>
				</p>
			</form>
		</div>
	</div>
	{% endif %}
	<div class="facet-cat portlet x4">
		<div class="portlet-header">
			<h3>{% trans "Catégories" %}</h3>
		</div>
		<div class="portlet-top">
			<a href="{% facet_url breadcrumbs -"par-categorie" %}">{% trans "Voir tous les résultats" %}</a>
		</div>
		<div class="portlet-bottom">
			{% for field in form %}
			  {% if not field.data %}
				 {% if field.name == 'categories' %}
					<ul class="root">
						{% for value, count in facets.fields|hash:field.name  %}
							{% with value|category as category %}
								{% if category.is_root_node %}
								<li>
									<a href="{% facet_url breadcrumbs field.field.pretty_name category.slug %}">{{ category.name }}</a> 
								</li>
								{% endif%}
							{% endwith %}
						{% endfor %}
					</ul>
					{% endif%}
				{% endif %}
			{% endfor %}
		</div>
	</div>
	{% endif %}{# if product_list #}
</div>{# content #}
{% endblock %}