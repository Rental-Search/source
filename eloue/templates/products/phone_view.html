{% extends "base.html" %} 
{% load i18n product cache %} 
{% block title %}{% trans "Appeler le propriétaire"%}{% endblock %}
{% block tail %}
	{{ block.super }}
	<script>
        enabled = {};
        function availability(year, month, inst) {
            $.ajax({
                type: 'GET',
                url: 'occupied_date/',
                dataType: 'json',
                data: {year:year, month:month},
                success: function(response) {
                    enabled = {};
                    for (i in response) {
                        enabled[response[i][0]] = response[i][1];
                    }
                    if (typeof(inst) == 'undefined'){
                        $('.hasDatepicker').datepicker("refresh");
                    } else {
                        inst.input.datepicker("refresh");
                    }
                }
            });
        }

        beforeShowDay = function(date) {
            today = new Date();
            today.setHours(0);
            today.setMinutes(0);
            today.setSeconds(0);
            today.setMilliseconds(0);
            if (date < today) {
                return [false, 'outdated'];
            }
            c = date.getFullYear()+'-'+('0'+(date.getMonth()+1)).slice(-2)+'-'+('0'+date.getDate()).slice(-2);
            if (c in enabled && !enabled[c]) return [false, 'unavailable'];
            return [true];
        }
        
        onChangeMonthYear = function(year, month, inst) {
            availability(inst.drawYear, inst.drawMonth + 1, inst);
        }

        beforeShow = function(input, inst) {
            setTimeout(
                //XXX: outside a timeout it doesn't work, dunno why
                function(){
                    availability(inst.selectedYear, inst.selectedMonth + 1, inst);
            }, 0);
        }

        $(document).ready(function () {
            date = new Date();
            $(".calendar-display").datepicker(
                {
                    minDate: 0,
                    maxDate: '+360d',
                    beforeShowDay: beforeShowDay,
                    onChangeMonthYear: onChangeMonthYear
                }
            );

            //Display datepicker on product detail page
            startDate = $('input[name$=started_at_0]');
            startDate.datepicker({
                dateFormat: 'dd/mm/yy',
                defaultDate: '+1d',
                minDate: 0, 
                maxDate: '+360d',
                beforeShow: beforeShow,
                beforeShowDay: beforeShowDay,
                onChangeMonthYear: onChangeMonthYear,
                onSelect: function(dateText, inst) {
                    var date1 = $(this).datepicker('getDate');
                    var date = new Date( Date.parse( date1 ) ); 
                    date.setDate( date.getDate() );
                    var newDate = date.toDateString(); 
                    newDate = new Date( Date.parse( newDate ) );
                    var ended_at = $('input[name$=ended_at_0]');
                    ended_at.datepicker("option", "minDate", newDate);
                    ended_at.datepicker('setDate', newDate );
                    bookingPrice($('#booking_create'));
                }
            }).datepicker('setDate', '+1d');
            
            endDate = $('input[name$=ended_at_0]');
            endDate.datepicker({
                defaultDate: '+2d',
                dateFormat: 'dd/mm/yy',
                beforeShowDay: beforeShowDay,
                onChangeMonthYear: onChangeMonthYear,
                beforeShow: beforeShow
            }).datepicker('setDate', '+2d');

            availability(date.getFullYear(), date.getMonth()+1);
        });
    </script>
{% endblock %}
{% block content %}
	<div class="container-main">
		<ul class="breadcrumb">
        <li><a href="{% url home %}">{% trans "Accueil" %}</a></li>
		{% for category in product.category.get_ancestors %}
		 <li><a href="{{ category.get_absolute_url }}">{{ category.name|capfirst }}</a></li>
		{% endfor %}
		<li><a href="{{ product.category.get_absolute_url }}">{% trans "Location" %} {{ product.category|capfirst }}</a></li>
		<li><a href="{{ product.get_absolute_url }}">{{ product.summary|capitalize }}</a></li>
		<li class="lastb">{% trans "Appeler" %}</li>
    </ul>{# breadcrumb #}
		<h1 style="margin: 30px 260px">{% trans "Besoin d'informations avant de faire la location ?"%}</h1>
		<div class="content-main" style="margin: 0 180px;">
			<div class="step">
				<h2><span style="color: #ff7200">Etape 1</span> : Téléphonez au propriétaire de l'annonce</h2>
				<p>Cet appel vous sera facturé 1,35 €/ appel + 0,35 €/ mn. Après 21h, afin de respecter la tranquillité des membres du site, merci de contacter les loueurs uniquement  par <a href="{% url message_create product.pk product.owner.pk %}">messagerie</a>.</p>
				<span class="number">{{ number }}</span>
			</div>
			<div class="step">
				<h2><span style="color: #ff7200">Etape 2</span> : Réservez en ligne</h2>
				<p>
					Dès que vous êtes mis d'accord par téléphone avec le loueur, effectuez votre réservation en ligne : Paiment et caution sécurisés, assurance incluse dans le prix affiché, contrat de location pré-rempli, contribution aux notations et commentaires.

				</p>
				<div style="width: 300px; margin: 30px auto 0;">
				
					<div class="booking-block">
            <h2>
                {% if product.owner.current_subscription %}
                    {% trans "Demande de réservation" %}
                {% else %}
                    {% trans "Réservez en ligne" %}
                {% endif %}
            </h2>
            <form id="booking_create" action="" method="POST">
                {% csrf_token %}
                <div class="top-block">
                {% with product.daily_price as price %}
                {% if price %}
                    {{ price }} <span>{% blocktrans with price.unit|unit as unit %} / par {{ unit }}{% endblocktrans %}</span>
                {% else %}
                    {% trans "Sur devis" %}
                {% endif %}
                {% endwith %}
                </div>{# top block #}
                <div class="main-block">
                    <div class="booking-dates form-stacked">
                        <p class="start-date">
                            <label>{% trans "Début" %} :</label>
                            {{ form.started_at }}
                        </p>
                        <p class="end-date">
                            <label>{% trans "Fin" %} :</label>
                            {{ form.ended_at }}
                        </p>
                        {% if product.quantity > 1 %}
                        <p class="quantity-input">
                            <label>{% trans "Quantité" %} :</label>
                            {{ form.quantity }}
                        </p>
                        {% else %}
                        {{ form.quantity }}
                        {% endif %}
                    </div>
                    <div id="available">
                        <p class="available">Ces dates sont disponibles</p>
                    </div>
                </div>{# main-block #}
                 <div class="bottom-block">
                    {% if product.daily_price %}
                    {% blocktrans with product.daily_price as day_price %}
                        <p id="booking-total" class="total-price">
                            Total : <span class="day">1 jour</span> soit <span class="pricing">{{ day_price }}</span>
                        </p>
                    {% endblocktrans %}
                    {% endif %}
                        <p>
                            {% if product.owner.current_subscription %}
                            <input type="submit" class="btn-booking" value="{% trans "Envoyer" %}"/>
                            {% else %}
                            <input type="submit" class="btn-booking" value="{% trans "Réserver" %}"/>
                            {% endif %}
                        </p>
                        <p class="booking-info">
                            {% if product.owner.current_subscription %}
                                {% trans "Il s'agit d'une demande de réservation.<br>Le loueur va vous contacter rapidement. Le prix total est indicatif." %}
                            {% else %}
                                {% trans "Il s'agit simplement d'une pré-réservation. Vous ne serez débité que si le propriétaire accepte la demande de location sous 24h."%}
                            {% endif %}
                        </p>
                    </form>
                </div><!-- bottom-block -->
        </div>{# booking-block #}
			</div>
		</div>
		</div>
	</div>
	<style type="text/css">
		.number {
			display: block;
			background: #5da713;
			margin: 20px auto;
			padding: 20px;
			font-size: 24px;
			color: #ffffff;
			text-align: center;
			width: 200px;
		}
		.step {
			margin-bottom: 30px;
		}

	</style>
{% endblock %}