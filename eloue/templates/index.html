{% extends "base.html" %}
{% load i18n compressed mptt_tags product cache %}

{% block title %}{% trans "Location entre particuliers ou professionnels de tout type d'objet" %}{% endblock %}

{% block head %}
 {{ block.super }}
 <link rel="canonical" href="{% if request.is_secure %}https{%else%}http{%endif%}://www.e-loue.com/">
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-top">
    <div class="search-home">
        <h1 class="rent-anythings">{% trans "Rejoignez la communauté des e-loueurs !" %} <br> 
            <small>{% trans "Au lieu d'acheter, louez pour augmenter votre pouvoir d'usage." %}</small>
        </h1>
        <form action="{% url product_list %}" method="get">
            <p class="what">
                {{form.q}}
                <input type="submit" value="{% trans "Rechercher" %}" class="btn bt-big-orange" />
                {{form.l.as_hidden}}
            </p>
        </form>
            <p class="city">
                <span class="city-to">à </span>
                <span class="city-name" id="city-name">
                    {% with request.session.location as location %}
                        {% firstof location.formatted_address location.city location.region location.country location.fallback %}
                    {% endwith %}
                </span>
                <button class="btn-other-town"><span>{% trans "Changer de ville" %}</span></button>
            </p>
            <p class="city-input">
                <input id="id_l" type="text" name="city" />
                <button class="btn-edit-town">{% trans "me geolocaliser" %}</button> {% trans "ou" %} <button class="btn-cancel-edit-town">{% trans "annuler" %}</button>
            </p>
    </div><!-- search-home -->
    <div class="products-home">
        <h2>{% trans "Annonces de location déposées près de chez vous :"%}</h2>
        <div class="products-home-tabs ui-tabs ui-widget ui-widget-content ui-corner-all">
            <ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
                <li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#near">{% trans "Objets" %}</a></li>
                <li class="ui-state-default ui-corner-top"><a href="#near_car">{% trans "Voitures" %}</a></li>
                <li class="ui-state-default ui-corner-top"><a href="#near_realestate">{% trans "Logements" %}</a></li>
                <li class="ui-state-default ui-corner-top"><a href="#hotloc">{% trans "Locations du moment" %}</a></li>
            </ul>
            <div id="near" class="ui-tabs-panel ui-widget-content ui-corner-bottom">
                {# <ul class="product-list"></ul> #}
                {% with 28 as truncation %}
                    {% include 'products/partials/result_list.html' %}
                {% endwith %}
                <p class="more-product">
                    <a href="#" class="more-product-link">{% trans "Chargez plus d'annonces..." %}</a>
                </p>
            </div>{# near #}
            <div id="near_car" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide">
                {# <ul class="product-list"></ul> #}
                {% with car_list as product_list %} 
                    {% with 28 as truncation %}
                        {% include 'products/partials/result_list.html' %}
                    {% endwith %}
                {% endwith %}
                <p class="more-product">
                    <a href="#" class="more-product-link">{% trans "Chargez plus d'annonces..." %}</a>
                </p>
            </div>{# near #}
            <div id="near_realestate" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide">
                {# <ul class="product-list"></ul> #}
                {% with realestate_list as product_list %} 
                    {% with 28 as truncation %}
                        {% include 'products/partials/result_list.html' %}
                    {% endwith %}
                {% endwith %}
                <p class="more-product">
                    <a href="#" class="more-product-link">{% trans "Chargez plus d'annonces..." %}</a>
                </p>
            </div>{# near #}
            <div id="hotloc" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide">
                {% cache 43200 curiosities site %}
                    <ul class="product-list">
                    {% for curiosity in curiosities %}
                        {% with curiosity.product as product %}
                            <li>
                                {% include "products/partials/product.html" %}
                            </li>
                        {% endwith %}
                    {% endfor %}
                    </ul>
                {% endcache %}
            </div>{# hotloc #}
        </div>{# products-home-tabs #}
    </div>{# product-home #}
    <div class="home-categories-container">
        <h2>{% trans "Annonces de location par catégories" %} :</h2>
        <div class="home-categories">
            {% for column in categories_list.items|partition:4%}
            <div class="home-categories-column {% if forloop.first %}first-column{% endif %}">
            {% for key, value in column %}
                <div class="home-categorie {% if forloop.last %}last-categorie{% endif %}">
                    <h3>{{ key.name }}</h3>
                    {% with key.product.pictures.all|first as picture %}
                    <img src="{{ picture.thumbnail.url }}" alt="{{ key.product.summary }}" width="60" height="60"/>
                    {% endwith %}
                    <ul>
                        {% for cat in value %}
                        <li><a href="{{ cat.get_absolute_url }}" title="{% trans "location"%} {{ cat.name }}">{% trans "Location" %} {{ cat.name|lower }}</a></li>
                        {% endfor %}
                    </ul>   
                </div>
            {% endfor %}
            </div>  
            {% endfor %}
        </div>{# home-categories #}
    </div>{# home-categories-container #}
    <ul class="args">
        <li class="arg-how">
            <a href="/temoignages/">
                <h4>{% trans "Témoignages" %}</h4>
            </a>
        </li>
        <li class="arg-iphoneApp">
            <a href="/mobile/iphone/">
                <img src="{{ STATIC_URL }}images/e-loue_sur_iPhone.png" width="204" height="126" />
                <h4>{% trans "L'appli pour tout louer !" %}</h4>
            </a>
        </li>
        <li class="arg-garanties">
            <a href="/assurance-tranquillite/">
                <img src="{{ STATIC_URL }}images/garanties.png" width="204" height="88" alt="{% trans "Les garanties e-loue"%}" />
                <h4>{% trans "La garantie" %}</h4>
                <img class="small_logo" src="{{ STATIC_URL }}images/small_logo.png" width="71" height="24" alt="{% trans "Location garantie"%}"/>
            </a>
        </li><!-- arg-garanties -->
        <li class="arg-fb">
            <div class="fb-iframe">
                <iframe src="//www.facebook.com/plugins/likebox.php?href=https%3A%2F%2Fwww.facebook.com%2Flocation.eloue&amp;width=224&amp;height=62&amp;colorscheme=light&amp;show_faces=false&amp;border_color=%23F3F8FA&amp;stream=false&amp;header=false&amp;appId=255056637886187" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:224px; height:62px;" allowTransparency="true"></iframe>
            </div>
            <a href="https://www.facebook.com/location.eloue">
                <h4>{% trans "Communauté"%}</h4>
            </a>
        </li>
    </ul>{# args #}
    {% cache 500 last_joined request.session.location.city site %}
    <div class="new-profils">
        <div class="np-title">{% trans "Derniers<br/>inscrits" %}</div><!-- np-title -->
        {% with last_joined as patron_list %}
          {% include "accounts/partials/avatar_list.html" %}
        {% endwith %}
    </div>{# new_profils #}
    {% endcache %}
    <div class="press">
        <div class="press-title">{% trans "Ils parlent de nous !"%}</div>
        <img src="{{ STATIC_URL }}images/e-loue_dans_la_press.png" width="619" height="39" />
    </div>{# press #}
</div>{# container-top #}
<!-- Advertiser 'Eloue',  Conversion tracking 'Eloue_CPC_arrivee' - DO NOT MODIFY THIS PIXEL IN ANY WAY -->
<img src="http://ad.yieldmanager.com/pixel?id=2174825&t=2" width="1" height="1" />
<!-- End of conversion tag -->
{% endblock %}

{% block tail %}
    {{ block.super }}
    <script src="//maps.googleapis.com/maps/api/js?sensor=false&amp;libraries=places" type="text/javascript"></script>
    <script type="text/javascript" >

        $(document).ready(function() {

            (function( $ ) {
              $.fn.loadMore = function(url, flag) {
                if (typeof(url) === 'undefined') {
                  this.data('offset', this.data('offset') + 1);
                  $.ajax({
                    url: this.data('url')+this.data('offset'),
                    success: function(result) {
                        console.log($('ul', this));
                        $('ul', this).append($('li', result));
                        $('.more-product-link', this).removeClass('loading');
                    },
                    cache: false,
                    dataType: 'html',
                    context: this
                  });
                } else {
                    if (typeof(flag) == 'undefined') {
                      $('ul', this).load(url+' li');
                      this.data('offset', 0);
                    } else {
                      this.data('offset', 1);
                    }
                    $('.more-product-link', this).click(function(e) {
                      e.preventDefault();
                      $(this).addClass('loading');
                      $(this.parentNode.parentNode).loadMore();
                    });
                    this.data('url', url);
                }
              };
            })( jQuery );

            location_changed = function(flag) {
                $('#near').loadMore('lists/object/', flag);
                $('#near_car').loadMore('lists/car/', flag);
                $('#near_realestate').loadMore('lists/realestate/', flag);
                $.ajax(
                    {
                        url:'/get_user_location/', 
                        cache: false,
                        success: function(response) {
                            $('.city-name').html(response);
                            $('#id_for_l').val(response);
                            $('.search-home').removeClass('editing');
                        }
                    }
                )
            }

            geolocation_stuff(location_changed);


            $(".products-home-tabs").show();
            location_changed(1);


            if (!$.cookie('geocoding')) 
                navigator.geolocation.getCurrentPosition(
                    SuccessBuilder(2, false, location_changed), 
                    geocoder_error_handler
                );
           
        });


    </script>
{% endblock %}

