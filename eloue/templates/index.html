{% extends "base.html" %}
{% load i18n compressed mptt_tags product cache %}

{% block title %}{% trans "Location entre particuliers ou professionnels de tout type d'objet" %}{% endblock %}

{% block head %}
 {{ block.super }}
 <link rel="canonical" href="{% if request.is_secure %}https{%else%}http{%endif%}://www.e-loue.com/">
{% endblock %}

{% block content %}
{% csrf_token %}
	<div id="search" class="xgrid">
        <div class="x12">
		  <h1>{% trans "Avec e-loue, tout se loue !" %}</h1>
		</div>
		<form class="form" action="{% url product_list %}">
		<div class="x5">
			<p>
				<label for="id_q">{% trans "Que voulez-vous louer ?" %}</label><br />
				{{ form.q }}<br />
				<span>{% trans "Exemple :" %} </span> <a href="{% url product_list %}?q={% trans "voiture" %}">{% trans "Voiture" %}</a>, <a href="{% url product_list %}?q={% trans "chèvre" %}">{% trans "Chèvre" %}</a>, <a href="{% url product_list %}?q={% trans "ski" %}">{% trans "Ski" %}</a>, <a href="{% url product_list %}?q={% trans "robe" %}">{% trans "Robe" %}</a>
			</p>
		</div>
		<div class="x5">
			<p>
				<label>{% trans "Où ?" %}</label><br />
				{{ form.l }}<br />
				<span>{% trans "Exemple :" %} </span> <a href="{% url product_list %}?l={% trans "Paris, 75012" %}">{% trans "Paris, 75012" %}</a>
			</p>
		</div>
		<div class="x2">
			<p>
				<input type="submit" value="{% trans "Rechercher" %}" class="btn big-orange"/>
			</p>
		</div>
		</form>
	</div>{# top-content #}
	<div id="content-home" class="xgrid">
	    <div class="x8">
    		<div class="content-header x8 first">
    		 <h2>{% trans "Les curiosités d'e-loue" %}</h2>
    		</div>
    		 {% cache 900 curiosities site %}
    	     {% for curiosity in curiosities|slice:":4" %}
    		  {% with curiosity.product as product %}
    		 	 {% if forloop.first %}
    			 	<div class="x2 first curiosity">
    			 {% else %}
    			 	<div class="x2 curiosity">
    			 {% endif %}
    			 	<a href="{{ product.get_absolute_url }}" class="curiosity-img">
    	  	   {% with product.pictures.all|first as picture %}
    				  <img src="{{ picture.home.url }}" alt="{{ product.summary }}"/>
    				 {% endwith %}
    				</a>
    				<h3>
    				    <a href="{{ product.get_absolute_url }}">{{ product.summary|lower|capfirst|truncate:20 }}</a>
    				</h3>
    				{% with product.prices.day|first as price %}
                    <span class="price">{{ price }}/jour</span>
                    {% endwith %}   
    			</div>
    		 {% endwith %}
    		{% endfor %}	 
    	{% endcache %}
    	 </div>
    	 <div class="x4 app-iphone">
     		<div class="content-header x4 first">
     		 <h2>{% trans "e-loue sur iPhone" %}</h2>
     		</div>
     	    <div class="x4 first">
     	        <div class="x2 first">
            	    <img src="{{ MEDIA_URL }}images/iphone/iphone.png" alt="{% trans "location entre particulier avec e-loue sur iphone" %}">
            	</div>
            	<div class="x2">
            	    <p>
            	        La première application iphone qui vous permet de tout louer!
            	    </p>
            	    <a  href="http://itunes.apple.com/fr/app/e-loue-mobile-app/id427538545" title="Cliquez pour télécharger l'application iphone e-loue" class="available">Disponible sur l'App Store</a>
            	    <a href="/mobile/iphone" title="Détails sur l'application iphone e-loue" class="more-details">En savoir plus ...</a>
            	</div>
     	    </div>
     	</div>
     	<div class="x12 horizontal-assurancy">
    	    <div class="guarantees">
    	        <div class="content-header">
        			<h2>{% trans "Avec les garanties e-loue, louez en toute sérénité !" %}</h2>
        		</div>
    			<div class="g-payment">
    			    {% blocktrans %}
    			     <p>Grâce à <strong>PayPal</strong>, bénéficiez du paiement le plus sécurisé au monde.</p>
    			    {% endblocktrans %}
    			</div>
    			<div class="g-assurancy">
    			    {% blocktrans %}
    			    <p>Nos <strong>partenaires</strong> assurent les locations de vos objets et de vos voitures.</p>
    				{% endblocktrans %}
    			</div>
    		</div>
    		<div class="assurancy-partner">
                <div class="assurancy-slide">
                    <a href="{% trans "/assurance-tranquillite/" %}" class="slide">
                        <img src="{{ MEDIA_URL }}images/logo_mma.png" alt="Assurance voiture MMA" width="200" height="65" class="mma"/>
                        <img src="{{ MEDIA_URL }}images/assurone.png" alt="Assurance objet Assurone" width="157" height="90" class="assurone"/>
                        <img src="{{ MEDIA_URL }}images/pp-verification-seal.gif" alt="PayPal" width="100" height="100" class="pp"/>
                    </a>
                </div>
            </div>
        </div>
        <div class="content-header x12">
    	 <h2>{% trans "Catégories" %}</h2>
    	</div>
    	{% cache 900 categories site %}
    	 {% full_tree_for_model products.Category as categories %}
    	 {% for column in categories|partition:4 %}
    	  <div class="x3 categories">
    	   {% for category in column %}
    	    {% if category.is_root_node %}
    	     {% drilldown_tree_for_node category as drilldown cumulative count products.Product.category in product_count %}
    	     {% for node,structure in drilldown|tree_info %}
    	      {% if node.is_root_node and node.slug != 'divers' %}
    	      <h3><a href="{{ node.get_absolute_url }}"> {% trans "Location "%} {{ node.name }}</a></h3>
    	      <ul>
    	      {% else %}
    	       {% if node.product_count %}
    	        <li><a href="{{ node.get_absolute_url }}">{% trans "Location "%}{{ node.name }}</a></li>
    	       {% endif %}
    	      {% if structure.closed_levels|length >= 2 %}</ul>{% endif %}
    	     {% endif %}
    	    {% endfor %}
    	   {% endif %}
    	  {% endfor %}
    	 </div>
        {% endfor %}
       {% endcache %}
       <div class="content-community">
           <div class="x8">
               <div class="content-header x8 first">
                   <h2>{% trans "Ils parlent de nous !" %}</h2>
               </div>
               <a href="{% trans "/espace-presse/" %}" title="{% trans "Espace presse" %}">
    		       <img src="{{ MEDIA_URL }}/images/presse_icons.png" alt="{% trans "e-loue dans les média" %}"/>
    	      </a>
	      </div>
  	      <div class="x4">
  	          <div class="box-tools clearfix">
  	              <h3>{% trans "Rejoignez notre communauté" %}</h3>
  	              <ul class="community-portlet-content">
  	                  <li class="fb">
  	                      <a href="https://www.facebook.com/pages/e-louecom/104685226447">
  	                          <span class="fb-icon"></span>
                  			  {% trans "Devenez fan<br>sur Facebook" %}
                  		  </a>
                      </li>
                      <li class="tw">
                          <a href="https://twitter.com/eloue">
                              <span class="tw-icon"></span>
                  			  {% trans "Suivez-nous<br>sur Twitter" %}
                  		  </a>
                  	  </li>
                  </ul>
  	          </div>
  	      </div>
       </div>
	</div>{# content #}
  <script type="text/javascript"
        src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
  <script src="//maps.googleapis.com/maps/api/js?sensor=false&amp;libraries=places" type="text/javascript"></script>
  <script type="text/javascript">


    function success(position) {
      geocoder = new google.maps.Geocoder();
      latlon = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
      geocoder.geocode(
        {'latLng':latlon}, 
        function(result) {
          console.log(result); 
          console.log(result[0]);
          $(document).ajaxSend(function(event, xhr, settings) {
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            function sameOrigin(url) {
                // url could be relative or scheme relative or absolute
                var host = document.location.host; // host + port
                var protocol = document.location.protocol;
                var sr_origin = '//' + host;
                var origin = protocol + sr_origin;
                // Allow absolute or scheme relative URLs to same origin
                return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                    (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                    // or any other URL that isn't scheme relative or absolute i.e relative.
                    !(/^(\/\/|http:|https:).*/.test(url));
            }
            function safeMethod(method) {
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
          });
          console.log(JSON.stringify(result[0]));
          $.post('user_geolocation/', {address: JSON.stringify(result[0])}, 
            function(response){ console.log(response); }, 'json');
        }
      );
    }
    function handleError(error) {
      alert(error.message);
    }
    navigator.geolocation.getCurrentPosition(success, handleError);
    autocomplete = new google.maps.places.Autocomplete(document.getElementById("id_l"), {types: ['geocode']});
    google.maps.event.addListener(autocomplete, 'place_changed', function() {
      console.log(autocomplete.getPlace());
      $.post('user_geolocation/', {address: JSON.stringify(autocomplete.getPlace())}, 
        function(response){ console.log(response); }, 'json');
    });
  </script>
{% endblock %}
