{% extends "base.html" %}
{% load i18n compressed mptt_tags product cache %}

{% block title %}{% trans "Location entre particuliers ou professionnels de tout type d'objet" %}{% endblock %}

{% block head %}
 {{ block.super }}
 <link rel="canonical" href="{% if request.is_secure %}https{%else%}http{%endif%}://www.e-loue.com/">
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-top">
    <div class="search-home">
        <h1 class="rent-anythings">{% trans "Rejoignez la communauté des e-loueurs !" %} <br> 
            <small>{% trans "Au lieu d'acheter, louez pour augmenter votre pouvoir d'usage." %}</small>
        </h1>
        <form action="{% url product_list %}" method="get">
            <p class="what">
                <input type="text" placeholder="Que voulez-vous louer ?" name="q" />
                <input type="submit" value="Rechercher" class="btn bt-big-orange" />
            </p>
        </form>
        <p class="city">
            <span class="city-to">à </span>
            <span class="city-name">{% firstof request.session.location.city "Boulogne-sur-Mer" %}</span>
            <button class="btn-other-town"><span>Changer de ville</span></button>
        </p>
        <p class="city-input">
            <input id="id_l" type="text" name="city" />
            <button class="btn-edit-town">Enregistrer</button> ou <button class="btn-cancel-edit-town">annuler</button>
        </p>
    </div><!-- search-home -->
    <div class="products-home">
        <div class="products-home-tabs">
            <ul>
                <li><a href="#near">Près d'ici</a></li>
                <li><a href="#moreRent">Les plus loué</a></li>
                <li><a href="#hotloc">Hot loc</a></li>
                <li><a href="#categories">Catégories</a><li>
            </ul>
            <div id="near">
              {% with last_added as product_list %}
                {% include "products/partials/product_list.html" %}
              {% endwith %}
            </div>{# near #}
            <div id="moreRent"></div>{# moreRent #}
            <div id="hotloc"></div>{# hotloc #}
            <div id="categories"></div>{# categories #}
        </div>{# products-home-tabs #}
    </div>{# product-home #}
    <ul class="args">
        <li class="arg-how">
            <a href="#">
                <h4>{% trans "Témoignage" %}</h4>
            </a>
        </li>
        <li class="arg-iphoneApp">
            <a href="#">
                <img src="{{ MEDIA_URL }}images/e-loue_sur_iPhone.png" width="204" height="126" />
                <h4>{% trans "L'appli pour tout louer !" %}</h4>
            </a>
        </li>
        <li class="arg-garanties">
            <a href="">
                <img src="{{ MEDIA_URL }}images/garanties_e-loue.png" width="204" height="50" />
                <h4>{% trans "Location garantie" %}</h4>
            </a>
        </li><!-- arg-garanties -->
        <li class="arg-fb"></li>
    </ul>{# args #}
    <div class="new-profils">
        <div class="np-title">{% trans "Derniers<br/>inscrits" %}</div><!-- np-title -->
        {% with last_joined as patron_list %}
          {% include "accounts/partials/avatar_list.html" %}
        {% endwith %}
    </div>{# new_profils #}
    <div class="press">
        <div class="press-title">Ils parlent de nous !</div>
        <img src="{{ MEDIA_URL }}images/e-loue_dans_la_press.png" width="778" height="49" />
    </div>{# press #}
</div>{# container-top #}

  <script src="//maps.googleapis.com/maps/api/js?sensor=false&amp;libraries=places" type="text/javascript"></script>
  <script type="text/javascript">

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    function sameOrigin(url) {
        // url could be relative or scheme relative or absolute
        var host = document.location.host; // host + port
        var protocol = document.location.protocol;
        var sr_origin = '//' + host;
        var origin = protocol + sr_origin;
        // Allow absolute or scheme relative URLs to same origin
        return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
            (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
            // or any other URL that isn't scheme relative or absolute i.e relative.
            !(/^(\/\/|http:|https:).*/.test(url));
    }
    function safeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    function success(position) {
      geocoder = new google.maps.Geocoder();
      latlon = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
      geocoder.geocode(
        {'latLng':latlon}, 
        function(result) {
          $(document).ajaxSend(function(event, xhr, settings) {
            if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
          });
          $.ajax({
            type: 'POST',
            url: 'http://{{request.get_host}}/user_geolocation/',
            data: {
              address: JSON.stringify(result[0]),
              coordinates: JSON.stringify({
                lat: latlon.lat(),
                lon: latlon.lng()
              }),
              source: 2
            },
            success: function(response) {
              if (response == 'OK') {
                window.location.reload(); 
              }
            }
          });
        }
      );
    }

    navigator.geolocation.getCurrentPosition(success);
    autocomplete = new google.maps.places.Autocomplete(document.getElementById("id_l"), {types: ['geocode']});
    google.maps.event.addListener(autocomplete, 'place_changed', function() {
      
      console.log(autocomplete.getPlace().geometry.location);

      $(document).ajaxSend(function(event, xhr, settings) {
        if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
        }
      });
      place = autocomplete.getPlace();
      $.post(
          'http://{{request.get_host}}/user_geolocation/', {
          address: JSON.stringify(autocomplete.getPlace()),
          coordinates: JSON.stringify({
            lat: place.geometry.location.lat(),
            lon: place.geometry.location.lng()
          }),
          source: 1
        }, 
        function(response){
          if (response == "OK"){
            window.location.reload();
          }
        }
      );
    });
  </script>
{% endblock %}
