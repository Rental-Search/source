{% extends "accounts/dashboard.html" %}
{% load i18n bookingaction %}


{% block owner_product %}
    {% if request.user == booking.owner %}selected-nav-bar-link{% endif %}
{% endblock %}
{% block borrower_booking %}
    {% if request.user == booking.borrower %}selected-nav-bar-link{% endif %}
{% endblock %}

{% block content-aside-profil %}
    {% if request.user == booking.borrower %}
        {% if booking.state == "authorized"%}{% url 'borrower_booking_authorized' as return_url %}{% endif %}
        {% if booking.state == "pending"%}{% url 'borrower_booking_pending' as return_url %}{% endif %}
        {% if booking.state == "ongoing"%}{% url 'borrower_booking_ongoing' as return_url %}{% endif %}
        {% if booking.state != "authorized" and booking.state != "pending" and booking.state != "ongoing" %}
            {% url 'borrower_booking_history' as return_url %}
        {% endif %}
    {% endif %}
    {% if request.user == booking.owner %}
        {% if booking.state == "professional"%} {% url 'owner_booking_authorized' as return_url %}{% endif %}
        {% if booking.state == "professional_saw"%} {% url 'owner_booking_authorized' as return_url %}{% endif %}
        {% if booking.state == "authorized"%}{% url 'owner_booking_authorized' as return_url %}{% endif %}
        {% if booking.state == "pending"%}{% url 'owner_booking_pending' as return_url %}{% endif %}
        {% if booking.state == "ongoing"%}{% url 'owner_booking_ongoing' as return_url %}{% endif %}
        {% if booking.state == "ended" or booking.state == "closing" or booking.state == "closed" %}
            {% url 'owner_booking_history' as return_url %}
        {% endif %}
        {% if booking.state == "rejected" %}{% url 'owner_booking_history' as return_url %}{% endif %}
    {% endif %}
    <div class="previous-sub-bar">
        &larr;  <a href="{{ return_url }}">{% trans "Retour aux réservations" %}</a>
    </div>
{% endblock %}

{% block content-main-profil %}
<h2>{% trans "La réservation" %}</h2>
<table class="table table-bordered booking-resume">
    <tbody>
        <tr>
            <th class="b-state">{{ booking.get_state_display }}</th>
            <td><a href="{{booking.product.get_absolute_url}}" class="b-title">{{booking.product.summary|capfirst}}</a></td>
        </tr>
        <tr>
            <th>{% trans "Début" %}</th>
            <td class="align-center">{{booking.started_at|date:"l d F Y H:i"|capfirst}}</td>
        </tr> 
        <th>{% trans "Fin" %}</th>
            <td class="align-center">{{booking.ended_at|date:"l d F Y H:i"|capfirst}}</td>
        </tr>
        {% if booking.quantity > 1 %}
        <tr>
            <th>{% trans "Quantité" %}</th>
            <td class="align-center"><b>{{booking.quantity}}</b></td>
        </tr>
        {% endif %}
        <tr>
            <th>{% trans "Montant" %}</th>
            <td class="align-center"><b>{{booking.total_amount}} &euro;</b></td>
        </tr>
        {% if request.user == booking.owner %}
        {% if booking.state == booking.STATE.PENDING or booking.state == booking.STATE.ENDED or booking.state == booking.STATE.CLOSED %}    
        <tr>
            <th>{% trans "Commission"%}</th>
            <td class="align-center"><b>{{booking.commission|floatformat:2}} &euro;</b></td>
        </tr>
        {% endif %}
        {% endif %}
        {% if not booking.state == "rejected" %}
        <tr class="b-action">
            <td colspan="2">{% bookingaction request booking %}</td>
        </tr>
        {% endif %}
    </tbody>
</table>

{% if request.user == booking.borrower %}
    <h2>{% trans "Information sur le propriétaire" %}</h2>
    <table class="table table-bordered booking-resume">
    <tr>
        <td class="b-profil-avatar" style="width: 100px; border-right: 1px solid #DDD;" rowspan="3">
            {% if booking.owner.avatar %}
                <img src="{{ booking.owner.avatar.profil.url }}" width="100" height="100" alt="">
            {% else %}
                <img src="{{ STATIC_URL }}images/default_avatar.png" width="100" height="100" alt="">
            {% endif %}
            <span style="margin-top: 0; margin-left: 10px;" class="stars empty"><span class="stars filled_{{ booking.owner.average_note }}"></span></span>
        </td>
        <td style="text-align: center; border-left: none;">
            <a href="{{ booking.owner.get_absolute_url }}">
            {% if booking.state == booking.STATE.AUTHORIZED or booking.state == booking.STATE.REJECTED %}
                {{ booking.owner.username|capfirst }}
            {% else %}
                {{ booking.owner.first_name|capfirst }} {{ booking.last_name|capfirst }}
            {% endif %}
            </a>
        </td>
    </tr>
    {% if booking.state == booking.STATE.AUTHORIZED or booking.state == booking.STATE.REJECTED %}
    <tr>
        <td style="text-align: center;">
            {{ booking.owner.default_address.city }} - {{ booking.owner.default_address.zipcode }}
        </td>
    </tr>
    {% else %}
    <tr>
        <td style="text-align: center;">
            {{ booking.owner.default_address.city }} - {{ booking.owner.default_address.zipcode }}
        </td>
    </tr>
    <tr>
        <td style="text-align: center;">
            {% with booking.owner.phones.all|first as phone %}
            {{ phone }}
            {% endwith %}
        </td>
    </tr>
    {% endif %}
    </table>
{% endif %}
{% if request.user == booking.owner %}
    <h2>{%  trans "Informations sur le locataire" %}</h2>
    <table class="table table-bordered booking-resume">
    <tr>
        <td class="b-profil-avatar" style="width: 100px; border-right: 1px solid #DDD;" rowspan="3">
            {% if booking.borrower.avatar %}
                <img src="{{ booking.borrower.avatar.profil.url }}" width="100" height="100" alt="">
            {% else %}
                <img src="{{ STATIC_URL }}images/default_avatar.png" width="100" height="100" alt="">
            {% endif %}
            <span style="margin-top: 0; margin-left: 10px;" class="stars empty"><span class="stars filled_{{ booking.borrower.average_note }}"></span></span>
        </td>
        <td style="text-align: center; border-left: none;">
            <a href="{{ booking.borrower.get_absolute_url }}">
            {% if booking.state == booking.STATE.AUTHORIZED or booking.state == booking.STATE.REJECTED %}
                {{ booking.borrower.username|capfirst }}
            {% else %}
                {{ booking.borrower.first_name|capfirst }} {{ booking.borrower.last_name|capfirst }}
            {% endif %}
            </a>
        </td>
    </tr>
    {% if booking.state == booking.STATE.AUTHORIZED or booking.state == booking.STATE.REJECTED %}
    <tr>
        <td style="text-align: center;">
            {{ booking.borrower.default_address.city }} - {{ booking.borrower.default_address.zipcode }}
        </td>
    </tr>
    {% else %}
    <tr>
        <td style="text-align: center;">
            {{ booking.borrower.default_address.city }} - {{ booking.borrower.default_address.zipcode }}
        </td>
    </tr>
    <tr>
        <td style="text-align: center;">
            {% with booking.borrower.phones.all|first as phone %}
            {{ phone }}
            {% endwith %}
        </td>
    </tr>
    {% endif %}
    </table>
{% endif %}
{% if booking.borrowercomment %}
    <div style="margin-bottom: 30px;">
        <h2 style="margin-bottom: 20px;">
            {% if request.user == booking.borrower %}
                {% trans "Votre commentaire"%}
            {% else %}
                {% trans "Commentaire du locataire"%}
            {% endif %}
        </h2>
        {% with booking.borrowercomment as comment %}
            {% include "rent/partials/comment.html" %}
        {% endwith %}
    </div>
{% endif %}
{% if booking.ownercomment %}
<div style="margin-bottom: 30px;">
    <h2 style="margin-bottom: 20px;">
        {% if request.user == booking.owner %}
            {% trans "Votre commentaire"%}
        {% else %}
            {% trans "Commentaire du propriétaire"%}
        {% endif %}
    </h2>
    {% with booking.ownercomment as comment %}
        {% include "rent/partials/comment.html" %}
    {% endwith %}
</div>
{% endif %}
{% endblock %}

{% block gaq %}
{% if messages %}
    {% for message in messages %}
        {% if message.tags == "success" %}
            {% if booking.state == "pending"%}
                    {% if booking.product.carproduct %}
                        _gaq.push(['_trackEvent', 'Réservation', 'Réservation acceptée', 'Voiture - {{ booking.product.category.name }}']);
                    {% endif %}
                    {% if booking.product.realestateproduct %}
                        _gaq.push(['_trackEvent', 'Réservation', 'Réservation acceptée', 'Logement - {{ booking.product.category.name }}']);
                    {% endif %}
                    {% if not booking.product.carproduct and not booking.product.realestateproduct %}
                        _gaq.push(['_trackEvent', 'Réservation', 'Réservation acceptée', 'Objet - {% for category in booking.product.category.get_ancestors %}{{ category.name }} - {% endfor %}{{ booking.product.category.name }}']);
                    {% endif %}
            {% endif %}
            {% if booking.state == "rejected"%}
                    {% if booking.product.carproduct %}
                        _gaq.push(['_trackEvent', 'Réservation', 'Réservation rejetée', 'Voiture - {{ booking.product.category.name }}']);
                    {% endif %}
                    {% if booking.product.realestateproduct %}
                        _gaq.push(['_trackEvent', 'Réservation', 'Réservation rejetée', 'Logement - {{ booking.product.category.name }}']);
                    {% endif %}
                    {% if not booking.product.carproduct and not booking.product.realestateproduct %}
                        _gaq.push(['_trackEvent', 'Réservation', 'Réservation rejetée', 'Objet - {% for category in booking.product.category.get_ancestors %}{{ category.name }} - {% endfor %}{{ booking.product.category.name }}']);
                    {% endif %}
            {% endif %}
            {% if booking.state == "canceled"%}
                    {% if booking.product.carproduct %}
                        _gaq.push(['_trackEvent', 'Réservation', 'Réservation annulée', 'Voiture - {{ booking.product.category.name }}']);
                    {% endif %}
                    {% if booking.product.realestateproduct %}
                        _gaq.push(['_trackEvent', 'Réservation', 'Réservation annulée', 'Logement - {{ booking.product.category.name }}']);
                    {% endif %}
                    {% if not booking.product.carproduct and not booking.product.realestateproduct %}
                        _gaq.push(['_trackEvent', 'Réservation', 'Réservation annulée', 'Objet - {% for category in booking.product.category.get_ancestors %}{{ category.name }} - {% endfor %}{{ booking.product.category.name }}']);
                    {% endif %}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endif %}
{% endblock %}

